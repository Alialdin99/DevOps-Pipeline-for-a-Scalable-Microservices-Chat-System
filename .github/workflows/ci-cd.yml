steps:
  # -------------------------
  # 1. Checkout repository
  # -------------------------
  - name: Checkout code
    uses: actions/checkout@v4

  # -------------------------
  # 2. Setup Node for Frontend
  # -------------------------
  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: 20

  - name: Install FE dependencies
    working-directory: ChatApp-FE/chime-together-app
    run: npm install

  - name: Build Frontend
    working-directory: ChatApp-FE/chime-together-app
    run: npm run build

  # -------------------------
  # 4. Login to Docker Hub
  # -------------------------
  - name: Login to Docker Hub
    uses: docker/login-action@v3
    with:
      username: ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}
      password: ${{ secrets.AYMAN_DOCKERHUB_TOKEN }}

  # -------------------------
  # 5. Build & Push All Images
  # -------------------------
  - name: Build and Push Docker Images
    run: |
      # Frontend
      docker build -t ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/chatapp-fe:latest ./ChatApp-FE/chime-together-app
      docker push ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/chatapp-fe:latest

      # Backend Microservices
      docker build -t ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/auth-service:latest ./AuthenticationService
      docker push ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/auth-service:latest

      docker build -t ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/chat-service:latest \
        -f ./ChattingService/ChattingService/Dockerfile \
        ./ChattingService
      docker push ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/chat-service:latest

      docker build -t ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/notify-service:latest \
        -f ./NotificationService/NotificationService/Dockerfile \
        ./NotificationService
      docker push ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/notify-service:latest

      docker build -t ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/user-service:latest ./UserService
      docker push ${{ secrets.AYMAN_DOCKERHUB_USERNAME }}/user-service:latest

  # -------------------------
  # 6. Deploy to Local Server
  # -------------------------
  - name: Deploy to Local Server via SSH
    uses: appleboy/ssh-action@v1.1.0
    with:
      host: ${{ secrets.SERVER_HOST }}
      username: ${{ secrets.SERVER_USER }}
      key: ${{ secrets.SERVER_SSH_KEY }}
      script: |
        cd ~/chatapp
        docker login -u ${{ secrets.AYMAN_DOCKERHUB_USERNAME }} -p ${{ secrets.AYMAN_DOCKERHUB_TOKEN }}
        docker compose pull
        docker compose up -d --remove-orphans
        docker image prune -f
